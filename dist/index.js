import{EventEmitter as Q}from"node:events";import{Socket as B}from"node:net";var v={BRIDGE_CREATE:"BridgeCreate",BRIDGE_DESTROY:"BridgeDestroy",BRIDGE_ENTER:"BridgeEnter",BRIDGE_INFO_CHANNEL:"BridgeInfoChannel",BRIDGE_INFO:"BridgeInfoComplete",BRIDGE_LEAVE:"BridgeLeave",BRIDGE_MERGE:"BridgeMerge",BRIDGE_LIST_ITEM:"BridgeListItem",BRIDGE_LIST_COMPLETE:"BridgeListComplete",CEL:"CEL",CORE_SHOW_CHANNEL:"CoreShowChannel",CORE_SHOW_CHANNEL_COMPLETE:"CoreShowChannelsComplete",DIAL1:"DialBegin",DIAL2:"DialEnd",DIAL_STATE:"DialState",DTMF1:"DTMFBegin",DTMF2:"DTMFEnd",HANGUP:"Hangup",HANGUP_REQUEST:"HangupRequest",HOLD:"Hold",NEW_CALLERID:"NewCallerid",NEW_CHANNEL:"Newchannel",NEW_CONNECTED_LINE:"NewConnectedLine",NEW_EXTEN:"NewExten",NEW_STATE:"NewState",ORIGINATE_RESPONSE:"OriginateResponse",Q_SUMMARY:"QueueSummary",Q_PARAMS:"QueueParams",Q_MEMBER_ADDED:"QueueMemberAdded",Q_MEMBER_PAUSE:"QueueMemberPause",Q_MEMBER_REMOVED:"QueueMemberRemoved",Q_MEMBER_PENALTY:"QueuePenalty",Q_MEMBER_RING_IN_USE:"QueueMemberRinginuse",Q_MEMBER:"QueueMember",Q_MEMBER_STATUS:"QueueMemberStatus",RTCP_SENT:"RTCPSent",RTCP_RECEIVED:"RTCPReceived",STATUS:"Status"},T=5038,A=`\r
`,w=`\r
\r
`,N=3,O=2,L=10,y={CONNECT:"connect",DO_RECONNECT:"do_reconnect",RECONNECTED:"reconnected",MAX_RECONNECT_REACH:"max-reconnect-reach",MAX_AUTH_REACH:"max-auth-reach",DO_LOGIN:"login",RE_LOGIN:"re-login",LOGGED_IN:"loggedin",SEND:"send",EVENTS:"events",RESPONSE:"response",ERROR_CONNECT:"error.connect",ERROR_LOGIN:"error.login",ERROR_LOGOUT:"error.logout",ERROR_RECONNECT:"error.reconnect"};function _(c){return c===void 0}function E(c){return c===null}function M(c){return E(c)||_(c)?!0:typeof c=="string"||Array.isArray(c)?c.length===0:typeof c=="object"&&c!==null?Object.keys(c).length===0:!1}function S(c){return Number.isNaN(c)}function P(c){return typeof c=="number"&&!Number.isNaN(c)}function d(c){if(E(c)||_(c)||S(c))return;let e=Number(c);return P(e)?e:void 0}function g(c){return c===null||_(c)||E(c)||S(c)?!1:Number.isFinite(c)}function b(c,e){for(let o=0;o<c.length;o++){let t=c[o];if(typeof t=="object"&&t!==null){for(let i in t)if(Object.prototype.hasOwnProperty.call(t,i)&&t[i]===e)return o}}return-1}var R=class{eAmi;timeOutAction;constructor(e){this.eAmi=e,this.timeOutAction=5e3}BridgeInfo(e){return new Promise((o,t)=>{(async()=>{e.Action="BridgeInfo",e.ActionID=new Date().getTime();let i=()=>{this.eAmi.events.removeListener(m.BRIDGE_INFO_CHANNEL,r)},r=n=>{o(n),i()};this.eAmi.events.once(m.BRIDGE_INFO_CHANNEL,r),setTimeout(()=>{t(`Timeout to '${e.Action}' action, try again later...`)},this.timeOutAction);try{let n=await this.eAmi.action(e);n?.Response?.toLowerCase()==="error"&&(t(n),i())}catch(n){t(n),i()}})()})}BridgeList(e){return new Promise((o,t)=>{(async()=>{_(e)&&t(new Error("Options are undefined")),e.Action="BridgeList",e.ActionID=new Date().getTime();let i=0,r=[],n=()=>{this.eAmi.events.removeListener(m.BRIDGE_LIST_COMPLETE,u),this.eAmi.events.removeListener(m.BRIDGE_LIST_ITEM,a)},a=s=>{r.push(s),i===r.length&&(o(r),n())},u=s=>{i=s.ListItems,i===r.length&&(o(r),n())};this.eAmi.events.once(m.BRIDGE_LIST_COMPLETE,u),this.eAmi.events.on(m.BRIDGE_LIST_ITEM,a),setTimeout(()=>{t(new Error(`Timeout to '${e.Action}' action, try again later...`))},this.timeOutAction);try{let s=await this.eAmi.action(e);s?.Response?.toLowerCase()==="error"&&(t(s),n())}catch(s){t(s),n()}})()})}CoreShowChannels(e){return new Promise((o,t)=>{(async()=>{_(e)&&t(new Error("Options are undefined")),e.Action="CoreShowChannels";let i=0,r=[],n=()=>{this.eAmi.events.removeListener(m.CORE_SHOW_CHANNEL,a),this.eAmi.events.removeListener(m.CORE_SHOW_CHANNEL_COMPLETE,u)},a=s=>{r.push(s),r.length===i&&(o(r),n())},u=s=>{i=s.ListItems,r.length===i&&(o(r),n())};this.eAmi.events.once(m.CORE_SHOW_CHANNEL_COMPLETE,u),this.eAmi.events.on(m.CORE_SHOW_CHANNEL,a),setTimeout(()=>{t(new Error(`Timeout to '${e.Action}' action, try again later...`))},this.timeOutAction);try{let s=await this.eAmi.action(e);s?.Response?.toLowerCase()==="error"&&(t(s),n())}catch(s){t(s),n()}})()})}Hangup(e){return new Promise((o,t)=>{(async()=>{_(e)&&t(new Error("Options are undefined")),e.Action="Hangup";let i={hangup:null,hangupRequest:null},r=()=>{this.eAmi.events.removeListener(m.HANGUP,n),this.eAmi.events.removeListener(m.HANGUP_REQUEST,a)},n=u=>{i.hangup=u,E(i.hangupRequest)||o(i),r()},a=u=>{i.hangupRequest=u,E(i.hangup)||o(i),r()};this.eAmi.events.once(m.HANGUP,n),this.eAmi.events.once(m.HANGUP_REQUEST,a),setTimeout(()=>{t(new Error(`Timeout to '${e.Action}' action, try again later...`))},this.timeOutAction);try{let u=await this.eAmi.action(e);u?.Response?.toLowerCase()==="error"&&(t(u),r())}catch(u){t(u),r()}})()})}Login(e){return new Promise((o,t)=>{(async()=>{_(e)&&t(new Error("Options are undefined")),e.Action="Login",e.ActionID=new Date().getTime(),setTimeout(()=>{t(new Error(`Timeout to '${e.Action}' action, try again later...`))},this.timeOutAction);try{let i=await this.eAmi.action(e);i.Response==="Success"?o(!0):i.Response==="Error"?t(i):o(!0)}catch(i){console.log("ERROR LOGIN",i),t(i)}})()})}Logout(){return new Promise((e,o)=>{(async()=>{let t=new Date().getTime();setTimeout(()=>{o(new Error("Timeout to 'Logoff' action, try again later..."))},this.timeOutAction);try{let i=await this.eAmi.action({Action:"Logoff",ActionID:t});this.eAmi.debug&&console.log("logout-response",i),_(i.Response)&&o(i),i.Response==="Goodbye"?e(!0):o(i)}catch(i){o(i)}})()})}Originate(e){return new Promise((o,t)=>{(async()=>{_(e)&&t(new Error("Options are undefined")),e.Action="Originate",e.ActionID=new Date().getTime();let i=()=>{this.eAmi.events.removeListener(`Action_${e.ActionID}`,r)},r=n=>{if(typeof n=="object"&&n!==null&&"Message"in n){let a=n.Message;if(_(a)){t(new Error("Message is undefined")),i();return}if(a.toString().toLowerCase().indexOf("failed")>=0){t(new Error("Action failed")),i();return}o(!0),i()}else t(new Error("Unexpected response format")),i()};this.eAmi.events.once(`Action_${e.ActionID}`,r),setTimeout(()=>{t(new Error(`Timeout to '${e.Action}' action, try again later...`))},this.timeOutAction);try{let n=await this.eAmi.action(e);n?.Response?.toLowerCase()==="error"&&(t(n),i())}catch(n){t(n),i()}})()})}Ping(){return new Promise((e,o)=>{(async()=>{let t=new Date().getTime();setTimeout(()=>{o(new Error("Timeout to 'Ping' action, try again later..."))},this.timeOutAction);try{let i=await this.eAmi.action({Action:"Ping",ActionID:t});i.Response==="Success"||i.Request?.Completed===!0?e(!0):i.Request?.Completed===!1&&o(i)}catch(i){o(i)}})()})}QueueMemberAdd(e){return new Promise((o,t)=>{(async()=>{_(e)&&t(new Error("Options are undefined")),e.Action="QueueAdd";let i=()=>{this.eAmi.events.removeListener(m.Q_MEMBER_ADDED,r)},r=n=>{o(n),i()};this.eAmi.events.once(m.Q_MEMBER_ADDED,r),setTimeout(()=>{t(new Error(`Timeout to '${e.Action}' action, try again later...`))},this.timeOutAction);try{let n=await this.eAmi.action(e);n?.Response?.toLowerCase()==="error"&&(t(n),i())}catch(n){t(n),i()}})()})}QueueMemberRemove(e){return new Promise((o,t)=>{(async()=>{_(e)&&t(new Error("Options are undefined")),e.Action="QueueRemove";let i=()=>{this.eAmi.events.removeListener(m.Q_MEMBER_REMOVED,r)},r=n=>{o(n),i()};this.eAmi.events.once(m.Q_MEMBER_REMOVED,r),setTimeout(()=>{t(new Error(`Timeout to '${e.Action}' action, try again later...`))},this.timeOutAction);try{let n=await this.eAmi.action(e);n?.Response?.toLowerCase()==="error"&&(i(),t(n))}catch(n){t(n),i()}})()})}QueueMemberPenalty(e){return new Promise((o,t)=>{(async()=>{_(e)&&t(new Error("Options are undefined")),e.Action="QueuePenalty";let i=()=>{this.eAmi.events.removeListener(m.Q_MEMBER_PENALTY,r)},r=n=>{o(n),i()};this.eAmi.events.once(m.Q_MEMBER_PENALTY,r),setTimeout(()=>{t(new Error(`Timeout to '${e.Action}' action, try again later...`))},this.timeOutAction);try{let n=await this.eAmi.action(e);n?.Response?.toLowerCase()==="error"&&(t(n),i())}catch(n){t(n),i()}})()})}QueueMemberPause(e){return new Promise((o,t)=>{(async()=>{_(e)&&t(new Error("Options are undefined")),e.Action="QueuePause";let i=()=>{this.eAmi.events.removeListener(m.Q_MEMBER_PAUSE,r)},r=n=>{o(n),i()};this.eAmi.events.once(m.Q_MEMBER_PAUSE,r),setTimeout(()=>{t(new Error(`Timeout to '${e.Action}' action, try again later...`))},this.timeOutAction);try{let n=await this.eAmi.action(e);n?.Response?.toLowerCase()==="error"&&(t(n),i())}catch(n){t(n),i()}})()})}QueueStatus(e){return new Promise((o,t)=>{(async()=>{_(e)&&t(new Error("Options are undefined")),e.Action="QueueStatus";let i=[],r=0,n=()=>{this.eAmi.events.removeListener(m.Q_MEMBER,a)},a=u=>{i.push(u),i.length===r&&(o(i),n())};this.eAmi.events.on(m.Q_MEMBER,a),setTimeout(()=>{t(new Error(`Timeout to '${e.Action}' action, try again later...`)),n(),this.QueueStatus(e)},this.timeOutAction);try{let u=await this.QueueSummary({Queue:e.Queue});r=u.Available+u.Callers+u.LoggedIn,e.MembersCount!==void 0&&e.MembersCount!==null?r=r===e.MembersCount?r:e.MembersCount:r=0,this.eAmi.debug&&console.log("Count queue members: available - %s, Callers - %s, LoggedIn - %s. Need count - %s",u.Available,u.Callers,u.LoggedIn,e.MembersCount??null);let s=await this.eAmi.action(e);typeof s=="object"&&s!==null&&"Response"in s&&(s.Response?.toLowerCase()==="error"?(t(s),n()):(this.eAmi.events.emit(m.Q_PARAMS,s),n()))}catch(u){t(u),n()}})()})}QueueSummary(e){return new Promise((o,t)=>{(async()=>{_(e)&&t(new Error("Options are undefined")),e.Action="QueueSummary";let i=()=>{this.eAmi.events.removeListener(m.Q_SUMMARY,r)},r=n=>{o(n),i()};this.eAmi.events.once(m.Q_SUMMARY,r),setTimeout(()=>{t(new Error(`Timeout to '${e.Action}' action, try again later...`))},this.timeOutAction);try{let n=await this.eAmi.action(e);n?.Response?.toLowerCase()==="error"&&(t(n),i())}catch(n){t(n),i()}})()})}Status(e){return new Promise((o,t)=>{(async()=>{_(e)&&t(new Error("Options are undefined")),e.Action="Status",e.ActionID=new Date().getTime();let i=()=>{this.eAmi.events.removeListener(m.STATUS,r)},r=n=>{o(n),i()};this.eAmi.events.once(m.STATUS,r),setTimeout(()=>{t(new Error(`Timeout to '${e.Action}' action, try again later...`))},this.timeOutAction);try{let n=await this.eAmi.action(e);n?.Response?.toLowerCase()==="error"&&(t(n),i())}catch(n){t(n),i()}})()})}};function q(c){return c.Event==="AgentComplete"}function $(c){return c.Event==="AgentCalled"}var l=y,m=v,D=class{debug;_host;_port;_userName;_password;_isLoggedIn;_emitAllEvents;_reconnect;_heartbeatOk=!1;_lastConnectedTime=0;_maxReconnectCount;_heartbeatInterval;_heartbeatHandler=void 0;_resendTimeOut;_successBitsByInterval;_errorBitsByInterval;_countReconnect;_excludeEvents;_queueRequest;_socketHandler=void 0;_actions;events;_maxAuthCount;_authCount;constructor(e){let o=e,t=_(o.additionalOptions)?{}:o.additionalOptions;this._host=o.host,this._port=E(o.port)?T:o.port,this._userName=o.userName,this._password=o.password,this._reconnect=t?.reconnect??!0,this._heartbeatInterval=(t?.heartbeatInterval??O)*1e3,this._resendTimeOut=(t?.resendTimeOut??N)*1e3,this._excludeEvents=t?.excludeEvents??[],this._emitAllEvents=t?.emitAllEvents??!1,this.debug=t?.debug??!1,this._maxReconnectCount=t?.maxReconnectCount??L,this._countReconnect=0,this._maxAuthCount=5,this._authCount=0,this._successBitsByInterval=0,this._errorBitsByInterval=0,this.events=new Q,this._queueRequest=[],this._isLoggedIn=!1,this._actions=new R(this),this.internalListeners()}internalListeners(){this.events.on(l.RE_LOGIN,()=>{this._authCount<this._maxAuthCount&&setTimeout(async()=>{this._authCount++;try{await this.login()}catch(e){this.debug&&console.log("re-login",e)}},1e3)})}get excludeEvents(){return this._excludeEvents}set excludeEvents(e){this._excludeEvents=e}get isLoggedIn(){return this._isLoggedIn}get lastConnectTime(){return this._lastConnectedTime}get actions(){return this._actions}get queueRequest(){return this._queueRequest}addSocketListeners(){this._socketHandler?this._socketHandler.on("close",()=>{this.debug&&console.log("close AMI connect")}).on("end",()=>{this.debug&&console.log("end AMI connect")}).on("data",e=>this.getData(e)):this.debug&&console.log("Socket handler is undefined, cannot add listeners.")}destroySocket(){this._socketHandler?(this._socketHandler.destroy(),this.debug&&console.log(`${A}Socket connection destroyed`)):this.debug&&console.log("Socket handler is undefined, cannot destroy socket.")}addRequest(e){this.queueRequest.push(e),this.events.emit(l.SEND,e)}removeRequest(e){if(_(e))return!1;let o=b(this.queueRequest,e);if(o<0)return!1;try{return this.queueRequest.splice(o,1),!0}catch(t){return this.debug&&console.log("Error remove request",t),!1}}getRequest(e){if(_(e))return null;let o=d(e),t=o!==void 0&&Number.isFinite(o)?o:e,i=b(this.queueRequest,t);return i<0?null:this.queueRequest[i]}setRequest(e,o){let t=this.getRequest(e);t&&(t=o)}keepConnection(){return new Promise((e,o)=>{(async()=>{clearInterval(this._heartbeatHandler);try{await this.actions.Ping()&&(this._heartbeatOk=!0,e(!0),this._successBitsByInterval++),this._heartbeatHandler=setTimeout(async()=>{try{await this.keepConnection()}catch(i){console.log("keep timeout error",i),this._errorBitsByInterval++}},this._heartbeatInterval)}catch(t){this._errorBitsByInterval++,console.log("keep connect error",t),o(t)}})()})}login(){return new Promise((e,o)=>{(async()=>{try{let t={Username:this._userName,Secret:this._password};this.events.emit(l.DO_LOGIN,t),await this.actions.Login(t),this.events.emit(l.LOGGED_IN),e(!0)}catch(t){if(this.events.emit(l.ERROR_LOGIN,t,"Authorization failed..."),this._authCount<this._maxAuthCount)setTimeout(()=>{this._authCount++,this.events.emit(l.RE_LOGIN,this._authCount)},1e3);else{this.events.emit(l.MAX_AUTH_REACH,this._authCount);try{await this.reconnect()}catch(i){o(i)}}}})()})}logout(){return new Promise((e,o)=>{(async()=>{try{await this.actions.Logout(),e(!0)}catch(t){this.events.emit(l.ERROR_LOGOUT,t),o("Failed to logout")}})()})}showSendPackages(){setInterval(()=>{console.log("Keep Connection. success sent - %s, error sent - %s",this._successBitsByInterval,this._errorBitsByInterval)},5e3)}connect(){return new Promise((e,o)=>{this._socketHandler=new B,this._socketHandler.connect(this._port,this._host),this._socketHandler.on("connect",async()=>{this.addSocketListeners();try{this.debug&&console.log("connection to the server"),await this.login(),this._isLoggedIn=!0,this._lastConnectedTime=new Date().getTime(),this.debug&&this.showSendPackages(),await this.keepConnection(),this.events.emit(l.CONNECT),e(this)}catch(t){this.debug&&console.log(t),o(t)}}).on("error",t=>{this.events.emit(l.ERROR_CONNECT,t,"Error connecting to an asterisk server"),this.debug&&console.log("Error connecting to an asterisk server",t),o(!1)})})}reconnect(){if(!this._reconnect)return Promise.resolve(!0);if(this._countReconnect<this._maxReconnectCount)this._countReconnect++;else return this.events.emit(l.MAX_RECONNECT_REACH,this._countReconnect),Promise.resolve(!1);return new Promise((e,o)=>{(async()=>{try{this.events.emit(l.DO_RECONNECT),await this.logout(),this.destroySocket(),await this.connect(),this.events.emit(l.RECONNECTED),e(!0)}catch(t){this.events.emit(l.ERROR_RECONNECT,t,"Could not connect to Asterisk..."),o("Could not connect to Asterisk...")}})()})}action(e){return new Promise((o,t)=>{let i=!1,r="";for(let h in e)h!=="ActionID"&&(r+=`${h}: ${e[h]}${A}`);_(e.ActionID)&&(e.ActionID=new Date().getTime());let n=e.ActionID;r+=`ActionID: ${n}${A}${A}`;let a=this.getRequest(n);a!=null?this.events.once(`Action_${n}`,h=>{a.Completed=!0,this.debug&&console.log("response",a.ActionID,a.Action),o(h)}):this.events.once(`Action_${n}`,h=>{o(h)});let u=d(n);if(u!==void 0&&!g(u)&&this.events.once(String(n),h=>{a!=null&&(a.Completed=!0),o(h)}),this.addRequest(e),a){let h=d(e.ActionID);typeof h=="number"&&g(h)?a.ActionID=h:typeof e.ActionID=="string"||typeof e.ActionID=="number"?a.ActionID=e.ActionID:a.ActionID=void 0,a.Completed=!0,a.timeOutHandler=setTimeout(async()=>{if(!i){t("Timeout write to socket...");return}if(a.Completed===!0){try{await this.action(e)}catch(I){this.debug&&console.log("Error resend action",a.Action,I),t(`Error resend action${a.Action}${I}`)}this._errorBitsByInterval++,this.debug&&console.log(`resend ActionID_${n}`,a.Action);return}clearTimeout(a.timeOutHandler),this.removeRequest(n),this.events.removeAllListeners(String(n)),this.events.removeAllListeners(`Action_${n}`),this.debug&&console.log(`complete ${n}`,a.Action)},3e3)}this._socketHandler?.write(r,()=>{i=!0})===!1&&(this.debug&&console.log("Data in the sending queue"),t("Data in the sending queue"))})}getData(e){let o=e.toString(),t,i="",r=[],n=[],a="",u=null,s={};for(o.startsWith("Asterisk Call Manager")&&(o=o.substring(o.indexOf(A)+2));t=o.indexOf(w),!(t<0);){r=o.substring(0,t+2).split(A),o=o.substring(t+4),s={},i="",n=[];for(let f=0;f<r.length;f++){if(r[f].indexOf(": ")<0)continue;if(n=r[f].split(": ",2),a=n[0].replace("'",""),u=n[1],i=f===0?a.toLowerCase():i,a==="ActionID"){let C=d(u);s[a]=C!==void 0&&g(C)?C:u;continue}let p=d(u);p!==void 0&&g(p)?u=p:(u&&u.indexOf("unknown")>=0||M(u)||u&&u.toLowerCase().indexOf("s")===0&&u.length===1)&&(u=null),s[a]=u??void 0}let h=this.getRequest(s.ActionID);s.Request=h!==null?h:void 0;let I=d(s.ActionID);switch(I!==void 0&&g(I)?this.events.emit(`Action_${I}`,s):typeof s.ActionID=="string"&&this.events.emit(s.ActionID,s),i){case"response":this.debug&&console.log(l.RESPONSE,A,s,A),this.events.emit(l.RESPONSE,s);break;case"event":this.debug&&console.log(l.EVENTS,A,s,A),s.Event!==void 0&&s.Event!==null&&s.Event!==""&&this.excludeEvents.indexOf(s.Event)<0&&(this._emitAllEvents&&this.events.emit(l.EVENTS,s),this.events.emit(s.Event,s));break;default:break}}return s}};export{m as AMI_EVENTS,l as eAMI_EVENTS,D as eAmi,$ as isAgentCalled,q as isAgentComplete};
//# sourceMappingURL=index.js.map
